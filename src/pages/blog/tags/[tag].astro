---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const allTags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return allTags.map((tag) => ({
    params: { tag: tag.toLowerCase().replace(/\s+/g, '-') },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags.includes(tag) && !post.data.draft)
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Posts tagged "${tag}" | Mikey Harper`}>
  <section class="mb-10">
    <h1 class="text-3xl font-bold font-mono text-text-primary mb-2">
      Tagged: {tag}
    </h1>
    <p class="text-text-secondary">{posts.length} post{posts.length !== 1 ? 's' : ''}</p>
  </section>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {posts.map((post) => (
      <PostCard
        title={post.data.title}
        date={post.data.date}
        description={post.data.description}
        headerImage={post.data.headerImage}
        slug={post.data.slug}
        tags={post.data.tags}
      />
    ))}
  </div>

  <div class="mt-10">
    <a href="/blog/" class="text-accent hover:underline font-mono text-sm">
      &larr; Back to all posts
    </a>
  </div>
</BaseLayout>
